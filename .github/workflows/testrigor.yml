name: CI/CD with TestRigor

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  test:
    runs-on: ubuntu-latest

    env:
      # Reemplaza estos valores con tus secretos de GitHub en Settings > Secrets and variables > Actions
      # O usa los valores directos si es un repo privado y seguro (no recomendado para repos públicos)
      TESTRIGOR_AUTH_TOKEN: ${{ secrets.TESTRIGOR_AUTH_TOKEN || '6a958ab2-85f3-448b-9f9d-d9a7e8a6f140' }}
      TESTRIGOR_SUITE_ID: ${{ secrets.TESTRIGOR_SUITE_ID || 'jsJR6vLAgQRcB2tCp' }}
      PORT: 4000

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install Dependencies
      run: |
        npm install
        # Instalar dependencias del cliente también si no lo hace el postinstall
        cd client && npm install

    - name: Build Application
      run: npm run build

    - name: Start Application
      run: |
        # Iniciar la aplicación en segundo plano
        npm run production &
        echo "Waiting for application to start..."
        npx wait-on http://localhost:4000

    - name: Start Cloudflare Tunnel
      id: tunnel
      run: |
        # Descargar e instalar cloudflared
        if [ "$RUNNER_OS" == "Linux" ]; then
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared.deb
        elif [ "$RUNNER_OS" == "Windows" ]; then
          choco install cloudflared
        fi

        # Iniciar el túnel
        # Usamos --url http://localhost:4000 para exponer el puerto local
        # Guardamos el log para extraer la URL
        cloudflared tunnel --url http://localhost:4000 > tunnel.log 2>&1 &
        
        # Esperar a que el túnel genere la URL
        echo "Waiting for Cloudflare Tunnel URL..."
        MAX_RETRIES=30
        COUNTER=0
        TUNNEL_URL=""
        
        while [ $COUNTER -lt $MAX_RETRIES ]; do
          if grep -q "trycloudflare.com" tunnel.log; then
            TUNNEL_URL=$(grep -o 'https://[^ ]*\.trycloudflare.com' tunnel.log | head -n 1)
            if [ -n "$TUNNEL_URL" ]; then
              echo "Tunnel started successfully!"
              break
            fi
          fi
          sleep 1
          COUNTER=$((COUNTER+1))
        done

        cat tunnel.log
        
        if [ -z "$TUNNEL_URL" ]; then
          echo "Error: Could not retrieve tunnel URL"
          exit 1
        fi
        
        echo "Tunnel URL: $TUNNEL_URL"
        echo "APP_URL=$TUNNEL_URL" >> $GITHUB_ENV

    - name: Run TestRigor Tests
      run: |
        # Asegurar finales de línea Unix por si se subió desde Windows
        sed -i 's/\r$//' scripts/run-testrigor.sh
        chmod +x scripts/run-testrigor.sh
        ./scripts/run-testrigor.sh
